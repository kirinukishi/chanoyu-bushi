<!DOCTYPE html>
<html lang="ja">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>お申し込み・お問い合わせ | 禅茶道 - New Year Premium Tea Experience</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400;500;700&family=Shippori+Mincho:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
</head>

<body class="contact-page-body">

    <div class="contact-header">
        <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
            <a href="index.html" class="back-link">
                <span>←</span> TOPページへ戻る
            </a>
            <div class="lang-switch-static">
                <a href="contact.html" class="active">JP</a> | <a href="contact_en.html">EN</a>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="form-container">
            <!-- 成功メッセージ (初期状態は非表示) -->
            <div id="success-message" style="display: none; text-align: center; padding: 4rem 0;">
                <h2 style="font-family: 'Noto Serif JP', serif; font-size: 2rem; margin-bottom: 2rem;">送信完了</h2>
                <p style="margin-bottom: 2rem; line-height: 2;">
                    お申し込みありがとうございます。<br>
                    以下の内容で受け付けました。<br>
                    担当者より確認のメールをお送りいたしますので、今しばらくお待ちください。
                </p>

                <!-- 申し込み内容表示エリア -->
                <div id="submission-summary"
                    style="text-align: left; background: rgba(255,255,255,0.05); padding: 2rem; border-radius: 8px; margin: 0 auto 3rem; max-width: 600px; border: 1px solid rgba(168, 138, 77, 0.3);">
                    <!-- JSで内容を挿入 -->
                </div>

                <a href="index.html" class="cta-button" style="display: inline-block; text-decoration: none;">
                    トップページへ戻る
                </a>
            </div>

            <!-- 入力フォーム (成功時は非表示にする) -->
            <div id="form-content-area">
                <h1 class="contact-form-title">ご予約フォーム</h1>

                <!-- Formspree configuration (AJAX handled) -->
                <form id="contact-form" action="https://formspree.io/f/mpqalgpz" method="POST">
                    <!-- ... Form fields ... -->

                    <div class="form-group">
                        <label for="hotel_name" class="form-label">
                            宿泊ホテル名 <span class="badge-optional">任意</span>
                        </label>
                        <input type="text" id="hotel_name" name="hotel_name" class="form-input" placeholder="例：帝国ホテル">
                    </div>

                    <div class="form-group">
                        <label for="concierge_name" class="form-label">
                            ご担当者様名（代理予約の場合） <span class="badge-optional">任意</span>
                        </label>
                        <input type="text" id="concierge_name" name="concierge_name" class="form-input"
                            placeholder="例：コンシェルジュ 佐藤 花子">
                    </div>

                    <div class="form-group">
                        <label for="name" class="form-label">
                            ご予約者様代表者名 <span class="required-badge">必須</span>
                        </label>
                        <input type="text" id="name" name="name" class="form-input" placeholder="例：山田 太郎" required>
                    </div>

                    <div class="form-group">
                        <label for="date" class="form-label">
                            ご希望日程 <span class="required-badge">必須</span>
                        </label>
                        <select id="date" name="date" class="form-select" required>
                            <option value="" disabled selected>選択してください</option>
                            <optgroup label="写楽館 (Sharakukan)">
                                <option value="1/1 (Wed) 13:45-15:15" data-id="day1">1/1 (水) 13:45 - 15:15</option>
                                <option value="1/2 (Thu) 13:45-15:15" data-id="day2">1/2 (木) 13:45 - 15:15</option>
                                <option value="1/3 (Fri) 13:45-15:15" data-id="day3">1/3 (金) 13:45 - 15:15</option>
                            </optgroup>
                            <optgroup label="浜離宮恩賜庭園 (Hama-rikyu Gardens)">
                                <option value="1/6 (Mon) 13:45-15:15" data-id="day6">1/6 (月) 13:45 - 15:15</option>
                                <option value="1/7 (Tue) 13:45-15:15" data-id="day7">1/7 (火) 13:45 - 15:15</option>
                                <option value="1/8 (Wed) 13:45-15:15" data-id="day8">1/8 (水) 13:45 - 15:15</option>
                                <option value="1/9 (Thu) 13:45-15:15" data-id="day9">1/9 (木) 13:45 - 15:15</option>
                            </optgroup>
                        </select>
                    </div>

                    <!-- Kimono Option (Conditionally Displayed) -->
                    <div id="kimono-option-container" class="form-group" style="display: none;">
                        <label class="form-label">
                            着付け体験オプション <span class="required-badge">選択</span>
                        </label>
                        <div
                            style="background: rgba(255, 255, 255, 0.05); padding: 1.5rem; border-radius: 4px; border: 1px solid rgba(168, 138, 77, 0.3);">
                            <p style="font-size: 0.9rem; margin-bottom: 1rem; color: #ccc;">
                                選択された日程は着付け体験が可能です。ご希望の場合は選択してください。<br>
                                <span style="font-size: 0.8rem; color: #888;">※料金や衣装は別途メールにて調整させていただきます。</span>
                            </p>
                            <div style="display: flex; gap: 2rem; align-items: center;">
                                <label style="cursor: pointer; display: flex; align-items: center; gap: 0.5rem;">
                                    <input type="radio" name="kimono_option" value="希望しない" checked
                                        style="accent-color: var(--color-accent);">
                                    希望しない
                                </label>
                                <label
                                    style="cursor: pointer; display: flex; align-items: center; gap: 0.5rem; color: var(--color-accent); font-weight: bold;">
                                    <input type="radio" name="kimono_option" value="希望する"
                                        style="accent-color: var(--color-accent);">
                                    希望する
                                </label>
                            </div>
                        </div>
                    </div>

                    <div class="form-group">
                        <label for="people" class="form-label">
                            参加人数 <span class="required-badge">必須</span>
                        </label>
                        <select id="people" name="people" class="form-select" required>
                            <option value="" disabled selected>選択してください (2名様より)</option>
                            <option value="2">2名</option>
                            <option value="3">3名</option>
                            <option value="4">4名</option>
                            <option value="5以上">5名以上（要相談）</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="allergy" class="form-label">
                            アレルギー・食事制限 <span class="badge-optional">任意</span>
                        </label>
                        <textarea id="allergy" name="allergy" class="form-input" rows="3"
                            placeholder="食物アレルギーや苦手な食材があればご記入ください（例：甲殻類、小麦、アルコールなど）"></textarea>
                    </div>

                    <div class="form-group">
                        <label for="email" class="form-label">
                            ご連絡先（メールアドレス）
                        </label>
                        <input type="email" id="email" name="email" class="form-input" placeholder="例：info@example.com">
                    </div>

                    <div class="form-group">
                        <label for="tel" class="form-label">
                            ご連絡先（お電話番号） <span class="required-badge">必須</span>
                        </label>
                        <input type="tel" id="tel" name="tel" class="form-input" placeholder="例：090-1234-5678" required>
                    </div>

                    <div class="form-group">
                        <label for="message" class="form-label">
                            その他・ご質問など
                        </label>
                        <textarea id="message" name="message" class="form-textarea" rows="4"
                            placeholder="ご質問やご要望がございましたらお書きください。"></textarea>
                    </div>

                    <div class="submit-btn-container" style="text-align: center; margin-top: 3rem;">
                        <div class="form-notes" style="text-align: left; max-width: 600px; margin: 0 auto 2rem;">
                            <p>【お支払いについて】<br>当日は<strong>現金のみ</strong>の現地決済となります。<br>クレジットカードはご利用いただけませんのでご了承ください。</p>
                            <p>【キャンセルについて】<br>ご予約確定後のキャンセルは致しかねます。<br>詳細はご予約確定メールにてご案内させていただきます。
                            </p>
                        </div>
                        <button type="submit" id="submit-button" class="cta-button"
                            style="border: none; cursor: pointer;">
                            内容を送信する
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 Chanoyu Bushi. All Rights Reserved.</p>
    </footer>

    <!-- Script to handle Form state and AJAX submission -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById("contact-form");
            const successMessage = document.getElementById("success-message");
            const formContentArea = document.getElementById("form-content-area");
            const summaryDiv = document.getElementById("submission-summary");

            if (form) {
                form.addEventListener("submit", (e) => {
                    e.preventDefault();

                    const submitBtn = document.querySelector("#submit-button");
                    const originalBtnText = submitBtn.textContent;
                    submitBtn.textContent = "送信中...";
                    submitBtn.disabled = true;

                    const formData = new FormData(form);

                    // Generate Summary HTML
                    let summaryHtml = '<ul style="list-style: none; padding: 0;">';

                    // Helper to get selected text for dropdowns
                    function getSelectedText(elementId) {
                        const el = document.getElementById(elementId);
                        if (el && el.selectedIndex !== -1) {
                            return el.options[el.selectedIndex].text;
                        }
                        return "";
                    }

                    // Field Mapping
                    const fields = [
                        { label: 'お名前', value: formData.get('name') },
                        { label: 'ご希望日程', value: getSelectedText('date') },
                        { label: '着付け体験', value: formData.get('kimono_option') },
                        { label: '参加人数', value: getSelectedText('people') },
                        { label: 'アレルギー等', value: formData.get('allergy') },
                        { label: 'メールアドレス', value: formData.get('email') },
                        { label: '電話番号', value: formData.get('tel') },
                        { label: 'その他', value: formData.get('message') }
                    ];

                    fields.forEach(field => {
                        if (field.value && field.value.trim() !== "") {
                            summaryHtml += `<li style="margin-bottom: 0.8rem; border-bottom: 1px dashed rgba(255,255,255,0.1); padding-bottom: 0.5rem;">
                                <span style="display: block; font-size: 0.8rem; color: #888; margin-bottom: 0.2rem;">${field.label}</span>
                                <span style="display: block; font-size: 1rem; color: #fff;">${field.value}</span>
                            </li>`;
                        }
                    });
                    summaryHtml += '</ul>';

                    // Send to Formspree via AJAX
                    fetch(form.action, {
                        method: form.method,
                        body: formData,
                        headers: {
                            'Accept': 'application/json'
                        }
                    }).then(response => {
                        if (response.ok) {
                            // Success
                            if (formContentArea) formContentArea.style.display = "none";
                            if (summaryDiv) summaryDiv.innerHTML = summaryHtml;
                            if (successMessage) successMessage.style.display = "block";

                            // Scroll to top
                            window.scrollTo(0, 0);
                        } else {
                            // Error
                            response.json().then(data => {
                                if (Object.hasOwn(data, 'errors')) {
                                    alert(data["errors"].map(error => error["message"]).join(", "));
                                } else {
                                    alert("送信中にエラーが発生しました。もう一度お試しください。");
                                }
                            });
                            submitBtn.textContent = originalBtnText;
                            submitBtn.disabled = false;
                        }
                    }).catch(error => {
                        alert("送信中にエラーが発生しました。ネットワーク接続をご確認ください。");
                        submitBtn.textContent = originalBtnText;
                        submitBtn.disabled = false;
                    });
                });
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 1. URLパラメータの処理（日付自動選択）
            const urlParams = new URLSearchParams(window.location.search);
            const dateParam = urlParams.get('date');

            if (dateParam) {
                const select = document.getElementById('date');
                if (select) {
                    const options = Array.from(select.options);
                    const matchingOption = options.find(option => option.value === dateParam);
                    if (matchingOption) {
                        select.value = dateParam;
                    }
                }
            }

            // 2. 空席状況の確認と反映（Google Sheets）
            // main.jsのキャッシュ問題を回避するため、ここで直接実行します
            const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQs5Fyt3R9IoY8kDf5r7ncndH3HsrOZS4M4H4R9thTYA-Nc8VFwDMEhOKBpyfAgwHFORnPAHD2Gr9Ys/pub?output=csv';

            async function checkAvailability() {
                try {
                    const response = await fetch(SHEET_CSV_URL);
                    const data = await response.text();
                    const rows = data.split('\n').slice(1); // ヘッダー除去

                    rows.forEach(row => {
                        // カンマ区切りで ID と Status を取得
                        const parts = row.split(',');
                        if (parts.length < 2) return;

                        const id = parts[0].trim();
                        const status = parts[1].trim().toLowerCase();

                        // ステータスが full なら選択肢を削除
                        if (id && status === 'full') {
                            const option = document.querySelector(`option[data-id="${id}"]`);
                            if (option) {
                                option.remove();
                                // もし選択されていた項目が消えた場合、選択状態をリセットする処理があっても良いが、
                                // 基本的には「消える」だけで十分
                            }
                        }
                    });
                } catch (error) {
                    console.error('Availability check failed:', error);
                } finally {
                    // データの反映が終わった後で、再度Kimonoオプションの表示判定を行う
                    if (typeof updateKimonoOptionVisibility === 'function') {
                        updateKimonoOptionVisibility();
                    }
                }
            }
            checkAvailability();

            // 3. 着付けオプションの表示制御
            const dateSelect = document.getElementById('date');
            const kimonoContainer = document.getElementById('kimono-option-container');
            const kimonoRadios = document.getElementsByName('kimono_option');

            // 着付け可能な日程ID (day3=1/3, day7=1/7, day8=1/8, day9=1/9)
            // ※index.htmlの記述に基づく
            const kimonoAvailableDays = ['day3', 'day7', 'day8', 'day9'];

            function updateKimonoOptionVisibility() {
                if (!dateSelect || !kimonoContainer) return;

                const selectedOption = dateSelect.options[dateSelect.selectedIndex];
                const selectedDayId = selectedOption ? selectedOption.getAttribute('data-id') : null;

                if (kimonoAvailableDays.includes(selectedDayId)) {
                    kimonoContainer.style.display = 'block';
                } else {
                    kimonoContainer.style.display = 'none';
                    // 非表示にする際は「希望しない」にリセット
                    if (kimonoRadios.length > 0) {
                        kimonoRadios[0].checked = true; // 0番目を「希望しない」とする想定
                    }
                }
            }

            if (dateSelect) {
                dateSelect.addEventListener('change', updateKimonoOptionVisibility);
                // 初期実行（戻るボタンやURLパラメータでの初期値反映用）
                // 少し遅延させて、上記のURLパラメータ処理やGoogle Sheets処理との競合を避けるのが安全ですが
                // ここでは同期的に呼んでも基本的に問題ないはずです。
                // 念のため、上記のパラメータ設定ロジックの直後に呼ばれるようにします。
                setTimeout(updateKimonoOptionVisibility, 100);
            }
        });
    </script>
</body>

</html>