<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Book Experience - Chanoyu Bushi</title>
    <link rel="preconnect" href="https://fonts.googleapis.com">
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
    <link
        href="https://fonts.googleapis.com/css2?family=Noto+Serif+JP:wght@300;400;500;700&family=Shippori+Mincho:wght@400;500;700&display=swap"
        rel="stylesheet">
    <link rel="stylesheet" href="assets/css/style.css">
    <link rel="icon" type="image/x-icon" href="favicon.ico">
    <!-- Microsoft Clarity Code -->
    <script type="text/javascript">
        (function (c, l, a, r, i, t, y) {
            c[a] = c[a] || function () { (c[a].q = c[a].q || []).push(arguments) };
            t = l.createElement(r); t.async = 1; t.src = "https://www.clarity.ms/tag/" + i;
            y = l.getElementsByTagName(r)[0]; y.parentNode.insertBefore(t, y);
        })(window, document, "clarity", "script", "uvlzh3yfr5");
    </script>
</head>

<body class="contact-page-body">

    <div class="contact-header">
        <div class="container" style="display: flex; justify-content: space-between; align-items: center;">
            <a href="index_en.html" class="back-link">
                <span>←</span> Back to Top
            </a>
            <div class="lang-switch-static">
                <a href="contact.html">JP</a> | <a href="contact_en.html" class="active">EN</a>
            </div>
        </div>
    </div>

    <div class="container">
        <div class="form-container">
            <!-- Success Message (Initially hidden) -->
            <div id="success-message" style="display: none; text-align: center; padding: 4rem 0;">
                <h2 style="font-family: 'Noto Serif JP', serif; font-size: 2rem; margin-bottom: 2rem;">Submission
                    Complete</h2>
                <p style="margin-bottom: 2rem; line-height: 2;">
                    Thank you for your booking request.<br>
                    We have received the following details.<br>
                    We will check the details and contact you shortly.
                </p>

                <!-- Submission Summary Area -->
                <div id="submission-summary"
                    style="text-align: left; background: rgba(255,255,255,0.05); padding: 2rem; border-radius: 8px; margin: 0 auto 3rem; max-width: 600px; border: 1px solid rgba(168, 138, 77, 0.3);">
                    <!-- JS inserts content here -->
                </div>

                <a href="index_en.html" class="cta-button" style="display: inline-block; text-decoration: none;">
                    Back to Top
                </a>
            </div>

            <!-- Form Content -->
            <div id="form-content-area">
                <h1 class="contact-form-title">Reservation Form</h1>

                <!-- Formspree configuration (AJAX handled) -->
                <form id="contact-form" action="https://formspree.io/f/mpqalgpz" method="POST">
                    <!-- Redirect removed, handled by JS -->

                    <div class="form-group">
                        <label for="hotel_name" class="form-label">
                            Hotel Name <span class="badge-optional">Optional</span>
                        </label>
                        <input type="text" id="hotel_name" name="hotel_name" class="form-input"
                            placeholder="e.g. Imperial Hotel">
                    </div>

                    <div class="form-group">
                        <label for="concierge_name" class="form-label">
                            Representative Name (Proxy Booking) <span class="badge-optional">Optional</span>
                        </label>
                        <input type="text" id="concierge_name" name="concierge_name" class="form-input"
                            placeholder="e.g. Concierge Hanako Sato">
                    </div>

                    <div class="form-group">
                        <label for="name" class="form-label">
                            Name <span class="required-badge">Required</span>
                        </label>
                        <input type="text" id="name" name="name" class="form-input" placeholder="e.g. John Smith"
                            required>
                    </div>

                    <div class="form-group">
                        <label for="date" class="form-label">
                            Preferred Date <span class="required-badge">Required</span>
                        </label>
                        <select id="date" name="date" class="form-select" required>
                            <option value="" disabled selected>Please Select</option>
                            <optgroup label="Sharakukan (写楽館)">
                                <option value="1/1 (Wed) 13:45-15:15" data-id="day1">Jan 1 (Wed) 13:45 - 15:15</option>
                                <option value="1/2 (Thu) 13:45-15:15" data-id="day2">Jan 2 (Thu) 13:45 - 15:15</option>
                                <option value="1/3 (Fri) 13:45-15:15" data-id="day3">Jan 3 (Fri) 13:45 - 15:15</option>
                            </optgroup>
                            <optgroup label="Hama-rikyu Gardens (浜離宮恩賜庭園)">
                                <option value="1/6 (Mon) 13:45-15:15" data-id="day6">Jan 6 (Mon) 13:45 - 15:15</option>
                                <option value="1/7 (Tue) 13:45-15:15" data-id="day7">Jan 7 (Tue) 13:45 - 15:15</option>
                                <option value="1/8 (Wed) 13:45-15:15" data-id="day8">Jan 8 (Wed) 13:45 - 15:15</option>
                                <option value="1/9 (Thu) 13:45-15:15" data-id="day9">Jan 9 (Thu) 13:45 - 15:15</option>
                            </optgroup>
                        </select>
                    </div>



                    <div class="form-group">
                        <label for="people" class="form-label">
                            No. of Guests <span class="required-badge">Required</span>
                        </label>
                        <select id="people" name="people" class="form-select" required>
                            <option value="" disabled selected>Please Select (Min 2)</option>
                            <option value="2">2 Guests</option>
                            <option value="3">3 Guests</option>
                            <option value="4">4 Guests</option>
                            <option value="5以上">5+ Guests (Please inquire)</option>
                        </select>
                    </div>

                    <div class="form-group">
                        <label for="allergy" class="form-label">
                            Allergies / Dietary Restrictions <span class="badge-optional">Optional</span>
                        </label>
                        <textarea id="allergy" name="allergy" class="form-input" rows="3"
                            placeholder="Please let us know if you have any allergies or dislikes (e.g. Shellfish, Wheat, Alcohol)."></textarea>
                    </div>

                    <div class="form-group">
                        <label for="email" class="form-label">
                            Email Address <span class="required-badge">Required</span>
                        </label>
                        <input type="email" id="email" name="email" class="form-input"
                            placeholder="e.g. info@example.com" required>
                    </div>

                    <div class="form-group">
                        <label for="tel" class="form-label">
                            Phone Number <span class="required-badge">Required</span>
                        </label>
                        <input type="tel" id="tel" name="tel" class="form-input" placeholder="e.g. +81-90-1234-5678"
                            required>
                    </div>

                    <div class="form-group">
                        <label for="message" class="form-label">
                            Requests / Questions
                        </label>
                        <textarea id="message" name="message" class="form-textarea" rows="4"
                            placeholder="Please write any questions or special requests."></textarea>
                    </div>

                    <div class="submit-btn-container" style="text-align: center; margin-top: 3rem;">
                        <div class="form-notes" style="text-align: left; max-width: 600px; margin: 0 auto 2rem;">

                            <p>【Cancellation】<br>Cancellation fees apply as materials are prepared in
                                advance.<br>Details will be sent via booking confirmation email.
                            </p>
                        </div>
                        <button type="submit" id="submit-button" class="cta-button"
                            style="border: none; cursor: pointer;">
                            Submit Booking
                        </button>
                    </div>
                </form>
            </div>
        </div>
    </div>

    <footer>
        <p>&copy; 2025 Chanoyu Bushi. All Rights Reserved.</p>
    </footer>

    <!-- Script to handle Form state and AJAX submission -->
    <script>
        document.addEventListener('DOMContentLoaded', () => {
            const form = document.getElementById("contact-form");
            const successMessage = document.getElementById("success-message");
            const formContentArea = document.getElementById("form-content-area");
            const summaryDiv = document.getElementById("submission-summary");

            if (form) {
                form.addEventListener("submit", (e) => {
                    e.preventDefault();

                    const submitBtn = document.querySelector("#submit-button");
                    const originalBtnText = submitBtn.textContent;
                    submitBtn.textContent = "Sending...";
                    submitBtn.disabled = true;

                    const formData = new FormData(form);

                    // Generate Summary HTML
                    let summaryHtml = '<ul style="list-style: none; padding: 0;">';

                    // Helper to get selected text for dropdowns
                    function getSelectedText(elementId) {
                        const el = document.getElementById(elementId);
                        if (el && el.selectedIndex !== -1) {
                            return el.options[el.selectedIndex].text;
                        }
                        return "";
                    }

                    // Field Mapping (English Labels)
                    const fields = [
                        { label: 'Hotel Name', value: formData.get('hotel_name') },
                        { label: 'Representative Name', value: formData.get('concierge_name') },
                        { label: 'Name', value: formData.get('name') },
                        { label: 'Date', value: getSelectedText('date') },

                        { label: 'Guests', value: getSelectedText('people') },
                        { label: 'Allergies', value: formData.get('allergy') },
                        { label: 'Email', value: formData.get('email') },
                        { label: 'Phone', value: formData.get('tel') },
                        { label: 'Requests', value: formData.get('message') }
                    ];

                    fields.forEach(field => {
                        if (field.value && field.value.trim() !== "") {
                            summaryHtml += `<li style="margin-bottom: 0.8rem; border-bottom: 1px dashed rgba(255,255,255,0.1); padding-bottom: 0.5rem;">
                                <span style="display: block; font-size: 0.8rem; color: #888; margin-bottom: 0.2rem;">${field.label}</span>
                                <span style="display: block; font-size: 1rem; color: #fff;">${field.value}</span>
                            </li>`;
                        }
                    });
                    summaryHtml += '</ul>';

                    // Send to Formspree via AJAX
                    fetch(form.action, {
                        method: form.method,
                        body: formData,
                        headers: {
                            'Accept': 'application/json'
                        }
                    }).then(response => {
                        if (response.ok) {
                            // Success
                            if (formContentArea) formContentArea.style.display = "none";
                            if (summaryDiv) summaryDiv.innerHTML = summaryHtml;
                            if (successMessage) successMessage.style.display = "block";

                            // Scroll to top
                            window.scrollTo(0, 0);
                        } else {
                            // Error
                            response.json().then(data => {
                                if (Object.hasOwn(data, 'errors')) {
                                    alert(data["errors"].map(error => error["message"]).join(", "));
                                } else {
                                    alert("An error occurred during submission. Please try again.");
                                }
                            });
                            submitBtn.textContent = originalBtnText;
                            submitBtn.disabled = false;
                        }
                    }).catch(error => {
                        alert("An error occurred. Please check your network connection.");
                        submitBtn.textContent = originalBtnText;
                        submitBtn.disabled = false;
                    });
                });
            }
        });
    </script>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            // 1. URLパラメータの処理（日付自動選択）
            const urlParams = new URLSearchParams(window.location.search);
            const dateParam = urlParams.get('date');

            if (dateParam) {
                const select = document.getElementById('date');
                if (select) {
                    const options = Array.from(select.options);
                    const matchingOption = options.find(option => option.value === dateParam);
                    if (matchingOption) {
                        select.value = dateParam;
                    }
                }
            }

            // 2. 空席状況の確認と反映（Google Sheets）
            // main.jsのキャッシュ問題を回避するため、ここで直接実行します
            const SHEET_CSV_URL = 'https://docs.google.com/spreadsheets/d/e/2PACX-1vQs5Fyt3R9IoY8kDf5r7ncndH3HsrOZS4M4H4R9thTYA-Nc8VFwDMEhOKBpyfAgwHFORnPAHD2Gr9Ys/pub?output=csv';

            async function checkAvailability() {
                try {
                    const response = await fetch(SHEET_CSV_URL);
                    const data = await response.text();
                    const rows = data.split('\n').slice(1); // ヘッダー除去

                    rows.forEach(row => {
                        // カンマ区切りで ID と Status を取得
                        const parts = row.split(',');
                        if (parts.length < 2) return;

                        const id = parts[0].trim();
                        const status = parts[1].trim().toLowerCase();

                        // ステータスが full なら選択肢を削除
                        if (id && status === 'full') {
                            const option = document.querySelector(`option[data-id="${id}"]`);
                            if (option) {
                                option.remove();
                                // もし選択されていた項目が消えた場合、選択状態をリセットする処理があっても良いが、
                                // 基本的には「消える」だけで十分
                            }
                        }
                    });
                } catch (error) {
                    console.error('Availability check failed:', error);
                } finally {
                    // Re-check Kimono option visibility after updating availability
                    // Removed logic
                }
            }
            checkAvailability();

            // 3. Kimono Option Visibility Control - Removed
        });
    </script>
</body>

</html>